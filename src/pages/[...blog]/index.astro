---
// src/pages/[...blog]/index.astro
export const prerender = false;

import Layout from '~/layouts/PageLayout.astro';
import type { MetaData } from '~/types';
import { theme } from '~/utils/theme';
import { getBlogPermalink } from '~/utils/permalinks';
import { getPosts, type ApiPost } from '@/lib/api';

const posts = await getPosts();

// UI용으로 가볍게 매핑
type UiPost = {
  id: number | string;
  title: string;
  excerpt?: string | null;
  date?: Date | null;
  url: string;
};

const items: UiPost[] = (posts ?? []).map((p: ApiPost) => ({
  id: p.id,
  title: p.title ?? '(제목 없음)',
  excerpt: p.excerpt ?? null,
  date: p.published_at ? new Date(p.published_at) : (p.created_at ? new Date(p.created_at) : null),
  url: `/blog/${p.id}`, // 상세 페이지 라우트는 아래에서 [id].astro로 잡을 거야
}));

const metadata: MetaData = {
  title: 'Blog',
  description: 'Latest posts',
  canonical: getBlogPermalink(),
  robots: { index: true, follow: true },
};
---

<Layout metadata={metadata}>
  <section class="mx-auto max-w-3xl px-4 py-8 sm:py-12">
    <h1 class="text-2xl font-semibold mb-6">Blog</h1>

    {items.length === 0 ? (
      <p class="text-muted">게시글이 없습니다.</p>
    ) : (
      <ul class="space-y-3">
        {items.map((p) => (
          <li class="border border-zinc-200 dark:border-slate-800 rounded px-4 py-3">
            <a href={p.url} class="font-medium hover:underline">{p.title}</a>
            {p.excerpt && <p class="text-sm text-muted mt-1">{p.excerpt}</p>}
            {p.date && <p class="text-xs text-muted mt-1">{p.date.toLocaleString()}</p>}
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>